
# **Temporal 기반 주문 처리 데모**

이 프로젝트는 **Temporal Workflow**를 사용하여 결제, 재고 관리, 배송 처리를 포함한 **주문 처리 시스템**을 구현합니다.  
주문 처리 시 결제 → 재고 확인 → 배송 단계를 거치며, 오류 발생 시 **Saga 패턴**을 통해 보상 작업(결제 환불, 재고 원복, 배송 취소)을 수행합니다.

---

## **프로젝트 구조**

### **서비스 구성**

1. **Order**: 주문 워크플로우 관리
2. **Payment**: 결제 처리 및 환불 관리
3. **Inventory**: 재고 확인 및 원복 처리
4. **Delivery**: 배송 처리 및 취소 관리
5. **Temporal**: Temporal 서버 및 관련 도구 제공
6. **PostgreSQL**: Temporal 백엔드 데이터베이스

---

## **주요 기술 스택**

- **Temporal**: 워크플로우 관리 및 오케스트레이션
- **Spring Boot**: 마이크로서비스 개발
- **Kotlin**: 언어
- **Docker** 및 **Docker Compose**: 서비스 컨테이너화 및 실행
- **PostgreSQL**: Temporal의 데이터 저장소

---

## **시스템 요구 사항**

- **Docker** 및 **Docker Compose**
- **Gradle** (프로젝트 빌드 도구)

---

## **프로젝트 실행 방법**

### 1. **빌드 및 실행 스크립트 실행**

다음 명령어를 통해 프로젝트를 빌드하고 실행합니다.

```bash
./build_and_run
```

이 스크립트는 다음 단계를 실행합니다:

1. **Gradle 빌드**: 테스트를 제외하고 프로젝트를 빌드합니다.
2. **Docker 이미지 빌드**: 각 마이크로서비스의 Docker 이미지를 빌드합니다.
3. **Docker Compose 실행**: 모든 서비스를 시작합니다.

---

### 2. **서비스 확인**

#### **Temporal 웹 UI**  
- **주소**: `http://localhost:8088`  
- Temporal의 워크플로우 및 작업 상태를 UI를 통해 확인할 수 있습니다.

#### **Order 서비스**  
- **포트**: `8081`  
- **API 문서**: Swagger나 Postman을 통해 테스트할 수 있습니다.

---

## **API 명세**

### **1. 주문 생성**

- **URL**: `POST /orders`  
- **설명**: 새로운 주문을 생성하고 워크플로우를 시작합니다.

**Request 예시**:
```json
{
  "orderId": "order-12345",
  "amount": 100.0
}
```

**Response 예시**:
```json
{
  "orderId": "order-12345",
  "workflowId": "order-workflow-order-12345",
  "status": "PROCESSING",
  "message": "Order workflow started successfully"
}
```

---

### **2. 주문 상태 확인**

- **URL**: `GET /orders/{workflowId}/status`  
- **설명**: 주문 워크플로우의 현재 상태를 조회합니다.

**Response 예시**:
```json
{
  "orderId": "order-1",
  "workflowId": "order-workflow-order-12345",
  "status": "COMPLETED",
  "message": "Current workflow status: COMPLETED"
}
```

---

## **Temporal 워크플로우 설명**

### **워크플로우 순서**

1. **결제 처리**  
   - 결제 금액 검증 및 결제 진행  
   - 실패 시 결제 보상(환불) 수행  

2. **재고 확인**  
   - 재고 할당 및 검증  
   - 실패 시 재고 원복  

3. **배송 처리**  
   - 배송지 검증 및 배송 진행  
   - 실패 시 배송 취소  

### **오류 처리 및 보상**

**Saga 패턴**을 통해 단계별 오류 발생 시 보상 작업을 수행합니다:

- 결제 실패 → **환불 수행**
- 재고 확인 실패 → **재고 원복**
- 배송 실패 → **배송 취소**

  
## 시나리오
### 공통 흐름
1.	결제 처리
  - 금액과 확률(20% 실패 확률)에 따라 결제 성공 또는 실패가 발생합니다.
  - 실패 시 결제 환불이 수행됩니다.
2.	재고 확인:
  -	재고 상황에 따라 재고 할당이 성공하거나 실패합니다.
  -	실패 시 재고 원복이 실행됩니다.
3.	배송 처리:
  -	orderId의 끝자리(0~9)에 따라 다양한 조건에 의해 배송 성공 또는 실패가 발생합니다.
  -	실패 시 배송 취소가 실행됩니다.
### order1 ~ order-9 시나리오
|Order ID|초기 재고|배송|결과|
|---|---|---|---|
|order-1|100|성공|주문 성공|
|order-2|0|미실행|주문 실패(재고 부족)|
|order-3|-1|미실행|주문 실패(단종된 상품)|
|order-4|50|성공|주문 성공|
|order-5|50|성공|주문 성공|
|order-6|50|성공|주문 성공|
|order-7|50|성공|주문 성공|
|order-8|50|성공|주문 성공|
|order-9|50|배송 불가|주문 실패(배송 불가)|
